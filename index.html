<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¸ì¢…ì‹œ ë¯¸ì„¸ë¨¼ì§€ í˜„í™©</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            transition: background-color 0.5s ease;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .chart-container {
            margin-top: 20px;
            position: relative;
            height: 400px;
        }
        .weather-info {
            text-align: center;
            margin: 20px 0;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ì„¸ì¢…ì‹œ ë¯¸ì„¸ë¨¼ì§€ í˜„í™©</h1>
        <div class="weather-info" id="weatherInfo"></div>
        <div class="chart-container">
            <canvas id="dustChart"></canvas>
        </div>
    </div>

    <script>
        // API í‚¤ëŠ” ì‹¤ì œ ì‚¬ìš© ì‹œ ë°œê¸‰ë°›ì•„ì•¼ í•©ë‹ˆë‹¤
        const API_KEY = 'pRvcuceiwsdG1bIqOi59QzdduSDsK36QYgBLLx6YBkdRYpTpUWT6HEsbnGr1KTd/pjBLQtwQah7cbcz4g0hbnw==';
        const CITY = 'ì„¸ì¢…';

        async function fetchDustData() {
            try {
                // ë” ì•ˆì •ì ì¸ CORS í”„ë¡ì‹œ ì‚¬ìš©
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const apiUrl = encodeURIComponent(`http://apis.data.go.kr/B552584/ArpltnInforInqireSvc/getCtprvnRltmMesureDnsty?serviceKey=${API_KEY}&returnType=json&numOfRows=24&pageNo=1&sidoName=${CITY}&ver=1.0`);
                
                const response = await fetch(proxyUrl + apiUrl);
                
                if (!response.ok) {
                    throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                console.log('API ì‘ë‹µ:', data);
                
                if (data.response && data.response.header) {
                    const resultCode = data.response.header.resultCode;
                    const resultMsg = data.response.header.resultMsg;
                    
                    if (resultCode !== '00') {
                        document.getElementById('weatherInfo').textContent = 
                            `API ì˜¤ë¥˜: ${resultMsg}`;
                        return null;
                    }
                    
                    const items = data.response.body.items;
                    if (!items || items.length === 0) {
                        document.getElementById('weatherInfo').textContent = 
                            'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        return null;
                    }
                    
                    // ë°ì´í„° ì •ë ¬ (ì‹œê°„ìˆœ)
                    items.sort((a, b) => new Date(b.dataTime) - new Date(a.dataTime));
                    return items;
                }
                
                return null;
            } catch (error) {
                console.error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                document.getElementById('weatherInfo').textContent = 
                    'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                return null;
            }
        }

        function updateBackground(weatherCondition) {
            const body = document.body;
            let weatherColor = '#F5F5F5'; // ê¸°ë³¸ìƒ‰
            
            switch(weatherCondition) {
                case 'ë§‘ìŒ':
                    weatherColor = '#87CEEB'; // í•˜ëŠ˜ìƒ‰
                    break;
                case 'êµ¬ë¦„ë§ìŒ':
                case 'íë¦¼':
                    weatherColor = '#B0C4DE'; // ì—°í•œ íšŒìƒ‰
                    break;
                case 'ë¹„':
                case 'ì†Œë‚˜ê¸°':
                    weatherColor = '#708090'; // íšŒìƒ‰
                    break;
                case 'ëˆˆ':
                    weatherColor = '#E6E6FA'; // ì—°í•œ ë³´ë¼ìƒ‰
                    break;
                case 'í™©ì‚¬':
                    weatherColor = '#D2B48C'; // ëª¨ë˜ìƒ‰
                    break;
                case 'ì•ˆê°œ':
                    weatherColor = '#D3D3D3'; // ì—°í•œ íšŒìƒ‰
                    break;
            }
            
            body.style.backgroundColor = weatherColor;
        }

        function getWeatherEmoji(weatherCondition) {
            switch(weatherCondition) {
                case 'ë§‘ìŒ':
                    return 'â˜€ï¸';
                case 'êµ¬ë¦„ë§ìŒ':
                    return 'â›…';
                case 'íë¦¼':
                    return 'â˜ï¸';
                case 'ë¹„':
                case 'ì†Œë‚˜ê¸°':
                    return 'ğŸŒ§ï¸';
                case 'ëˆˆ':
                    return 'â„ï¸';
                case 'í™©ì‚¬':
                    return 'ğŸŒªï¸';
                case 'ì•ˆê°œ':
                    return 'ğŸŒ«ï¸';
                default:
                    return 'ğŸŒ¤ï¸';
            }
        }

        function getDustStatus(value, type) {
            if (type === 'PM10') {
                if (value <= 30) return 'ì¢‹ìŒ';
                if (value <= 80) return 'ë³´í†µ';
                if (value <= 150) return 'ë‚˜ì¨';
                return 'ë§¤ìš° ë‚˜ì¨';
            } else { // PM2.5
                if (value <= 15) return 'ì¢‹ìŒ';
                if (value <= 35) return 'ë³´í†µ';
                if (value <= 75) return 'ë‚˜ì¨';
                return 'ë§¤ìš° ë‚˜ì¨';
            }
        }

        function getStatusEmoji(status) {
            switch(status) {
                case 'ì¢‹ìŒ':
                    return 'ğŸ˜Š';
                case 'ë³´í†µ':
                    return 'ğŸ˜';
                case 'ë‚˜ì¨':
                    return 'ğŸ˜·';
                case 'ë§¤ìš° ë‚˜ì¨':
                    return 'ğŸ¤¢';
                default:
                    return '';
            }
        }

        function createChart(data) {
            const ctx = document.getElementById('dustChart').getContext('2d');
            
            // ë°ì´í„° ì •ë ¬ (ì‹œê°„ìˆœ)
            data.sort((a, b) => new Date(a.dataTime) - new Date(b.dataTime));
            
            // ìµœì‹  ë°ì´í„° ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ 5ì‹œê°„ ì „ê¹Œì§€ì˜ ë°ì´í„° í•„í„°ë§
            const latestTime = new Date(data[data.length - 1].dataTime);
            const filteredData = data.filter(item => {
                const itemTime = new Date(item.dataTime);
                const timeDiff = (latestTime - itemTime) / (1000 * 60 * 60); // ì‹œê°„ ì°¨ì´ ê³„ì‚°
                return timeDiff <= 5;
            });
            
            // ì‹œê°„ ë ˆì´ë¸” ìƒì„± (ìµœì‹  ì‹œê°„ë¶€í„° 5ì‹œê°„ ì „ê¹Œì§€)
            const labels = [];
            for (let i = 5; i >= 0; i--) {
                const time = new Date(latestTime);
                time.setHours(time.getHours() - i);
                labels.push(`${time.getHours()}ì‹œ`);
            }

            const pm10 = filteredData.map(item => parseInt(item.pm10Value));
            const pm25 = filteredData.map(item => parseInt(item.pm25Value));

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'PM10 (ã/ã¥)',
                            data: pm10,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'PM2.5 (ã/ã¥)',
                            data: pm25,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ë†ë„ (ã/ã¥)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ì‹œê°„'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return labels[index];
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'ì„¸ì¢…ì‹œ ë¯¸ì„¸ë¨¼ì§€ ë†ë„ ë³€í™” (ìµœê·¼ 5ì‹œê°„)'
                        }
                    }
                }
            });
        }

        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ ${date.getHours()}ì‹œ`;
        }

        async function init() {
            const data = await fetchDustData();
            if (data) {
                createChart(data);
                const latestData = data[0]; // ì •ë ¬ëœ ë°ì´í„°ì˜ ì²« ë²ˆì§¸ í•­ëª©ì´ ìµœì‹  ë°ì´í„°
                const weatherEmoji = getWeatherEmoji(latestData.weatherCondition || 'ë§‘ìŒ');
                
                const pm10Value = parseInt(latestData.pm10Value) || 0;
                const pm25Value = parseInt(latestData.pm25Value) || 0;
                
                const pm10Status = getDustStatus(pm10Value, 'PM10');
                const pm25Status = getDustStatus(pm25Value, 'PM2.5');
                
                document.getElementById('weatherInfo').innerHTML = 
                    `<div>ìµœê·¼ ì¸¡ì • ì‹œê°„: ${formatDateTime(latestData.dataTime)}</div>
                     <div>í˜„ì¬ ë‚ ì”¨: ${weatherEmoji} ${latestData.weatherCondition || 'ë§‘ìŒ'}</div>
                     <div>PM10(ë¯¸ì„¸ë¨¼ì§€): ${pm10Value}ã/ã¥ ${getStatusEmoji(pm10Status)} ${pm10Status}</div>
                     <div>PM2.5(ì´ˆë¯¸ì„¸ë¨¼ì§€): ${pm25Value}ã/ã¥ ${getStatusEmoji(pm25Status)} ${pm25Status}</div>
                     <div style="font-size: 0.8em; color: #666; margin-top: 10px;">
                        â€» ë°ì´í„°ëŠ” 1ì‹œê°„ ë‹¨ìœ„ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
                     </div>`;
                
                updateBackground(latestData.weatherCondition || 'ë§‘ìŒ');
            }
        }

        // 1ì‹œê°„ë§ˆë‹¤ ë°ì´í„° ê°±ì‹ 
        setInterval(init, 3600000);

        init();
    </script>
</body>
</html>
